From 5ee99d8cfd903fa4e06e07ddabf6f1bfbe0c2737 Mon Sep 17 00:00:00 2001
From: lpgl05 <lpgl05@github.com>
Date: Mon, 29 Sep 2025 21:24:13 +0800
Subject: [PATCH 2/2] =?UTF-8?q?update=20-by=20=E9=BE=99?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 src/components/new-ui/GenerateControl.tsx |  10 +-
 src/components/new-ui/MaterialLibrary.tsx |  67 ++++++++++---
 src/components/new-ui/StepManager.tsx     | 114 +++++++++++++---------
 3 files changed, 125 insertions(+), 66 deletions(-)

diff --git a/src/components/new-ui/GenerateControl.tsx b/src/components/new-ui/GenerateControl.tsx
index 330e27d..68bdf19 100644
--- a/src/components/new-ui/GenerateControl.tsx
+++ b/src/components/new-ui/GenerateControl.tsx
@@ -1,6 +1,6 @@
 import React from 'react';
 import { Button, Progress, Card, Space, message } from 'antd';
-import { PlayCircleOutlined, DownloadOutlined, ShareAltOutlined } from '@ant-design/icons';
+import { PlayCircleOutlined, DownloadOutlined } from '@ant-design/icons';
 
 interface GeneratedVideo {
   id: string;
@@ -140,13 +140,7 @@ const GenerateControl: React.FC<GenerateControlProps> = ({
                 >
                   ä¸‹è½½è§†é¢‘
                 </Button>
-                <Button
-                  icon={<ShareAltOutlined />}
-                  onClick={() => handleShare(generatedVideo)}
-                  size="large"
-                >
-                  åˆ†äº«è§†é¢‘
-                </Button>
+                {/* åˆ†äº«åŠŸèƒ½æš‚æ—¶éšè— */}
               </Space>
             </div>
           </Card>
diff --git a/src/components/new-ui/MaterialLibrary.tsx b/src/components/new-ui/MaterialLibrary.tsx
index cf98009..3e8cc9d 100644
--- a/src/components/new-ui/MaterialLibrary.tsx
+++ b/src/components/new-ui/MaterialLibrary.tsx
@@ -56,16 +56,22 @@ const MaterialLibrary: React.FC<MaterialLibraryProps> = ({
       if (response.ok) {
         const data = await response.json();
         // è½¬æ¢åç«¯æ•°æ®æ ¼å¼ä¸ºå‰ç«¯Materialæ¥å£æ ¼å¼
-        const formattedMaterials = data.map((item: any) => ({
-          id: item.id,
-          name: item.name,
-          url: item.url,
-          type: item.type,
-          uploadDate: item.uploadedAt,
-          size: item.size,
-          duration: item.duration,
-          thumbnail: item.thumbnail
-        }));
+        const formattedMaterials = data.map((item: any) => {
+          const url: string = item.url || '';
+          const fallbackName = url ? decodeURIComponent(url.split('/').pop() || '') : '';
+          const name: string = item.name || fallbackName || 'æœªå‘½åç´ æ';
+          const uploadedAt: string = item.uploadedAt || item.createdAt || item.uploadDate || '';
+          return {
+            id: item.id,
+            name,
+            url,
+            type: item.type,
+            uploadDate: uploadedAt,
+            size: item.size,
+            duration: item.duration,
+            thumbnail: item.thumbnail
+          } as Material;
+        });
         setMaterials(formattedMaterials);
         console.log('æˆåŠŸè·å–ç´ æåˆ—è¡¨:', formattedMaterials.length, 'ä¸ªç´ æ');
         
@@ -152,6 +158,18 @@ const MaterialLibrary: React.FC<MaterialLibraryProps> = ({
         if (result.success) {
           // é‡æ–°åŠ è½½ç´ æåˆ—è¡¨ä»¥è·å–æœ€æ–°çš„ç´ æ
           await loadMaterials();
+          // ä¸Šä¼ åé»˜è®¤é€‰ä¸­ï¼šä¼˜å…ˆä½¿ç”¨è¿”å›çš„idï¼Œå¦åˆ™æŒ‰æ–‡ä»¶ååŒ¹é…
+          try {
+            if (result.id) {
+              onMaterialSelect(type, String(result.id), true);
+            } else {
+              const uploadedName = file.name;
+              const sameName = materials.find(m => m.type === type && (m.name === uploadedName || (m.url && decodeURIComponent(m.url.split('/').pop() || '') === uploadedName)));
+              if (sameName) {
+                onMaterialSelect(type, sameName.id, true);
+              }
+            }
+          } catch (_) {}
           message.success('ç´ æä¸Šä¼ æˆåŠŸï¼');
         } else {
           message.error(result.error || 'ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•');
@@ -234,8 +252,9 @@ const MaterialLibrary: React.FC<MaterialLibraryProps> = ({
       <Card
         hoverable
         className={`material-card ${isSelected ? 'selected' : ''}`}
+        onClick={() => onMaterialSelect(material.type, material.id, !isSelected)}
         cover={
-          <div className="material-preview" onClick={() => handlePreview(material)}>
+          <div className="material-preview" onClick={(e) => { e.stopPropagation(); handlePreview(material); }}>
             {material.type === 'poster' && material.url ? (
               // æµ·æŠ¥æ˜¾ç¤ºç¼©ç•¥å›¾
               <img 
@@ -337,7 +356,12 @@ const MaterialLibrary: React.FC<MaterialLibraryProps> = ({
           title={material.name}
           description={
             <div>
-              <div>ä¸Šä¼ æ—¶é—´ï¼š{new Date(material.uploadDate).toLocaleDateString()}</div>
+              <div>
+                ä¸Šä¼ æ—¶é—´ï¼š{isNaN(Date.parse(material.uploadDate)) ? '-' : new Date(material.uploadDate).toLocaleString()}
+              </div>
+              {typeof material.size === 'number' && (
+                <div>å¤§å°ï¼š{(material.size / 1024 / 1024).toFixed(2)}MB</div>
+              )}
               {material.duration && <div>æ—¶é•¿ï¼š{material.duration}ç§’</div>}
             </div>
           }
@@ -355,11 +379,29 @@ const MaterialLibrary: React.FC<MaterialLibraryProps> = ({
     
     // è·å–å½“å‰ç±»å‹çš„ä¸Šä¼ è¿›åº¦
     const currentUploads = Object.keys(uploadingFiles).filter(key => key.startsWith(type));
+    const allIds = typeMaterials.map(m => m.id);
+    const selectedIds = selectedMaterials[type + 's' as keyof typeof selectedMaterials] as string[];
+    const isAllSelected = allIds.length > 0 && allIds.every(id => selectedIds.includes(id));
+    const toggleSelectAll = () => {
+      if (isAllSelected) {
+        allIds.forEach(id => onMaterialSelect(type, id, false));
+      } else {
+        allIds.forEach(id => onMaterialSelect(type, id, true));
+      }
+    };
     
     return (
       <div className="material-section">
         <div className="section-header">
           <h4>{title}</h4>
+          <Space>
+            <Button 
+              size="small"
+              onClick={toggleSelectAll}
+              style={{ height: '28px', fontSize: '12px' }}
+            >
+              {isAllSelected ? 'å–æ¶ˆå…¨é€‰' : 'å…¨é€‰'}
+            </Button>
           <Upload
             multiple
             accept={type === 'video' ? 'video/*' : type === 'audio' ? 'audio/*' : 'image/*'}
@@ -381,6 +423,7 @@ const MaterialLibrary: React.FC<MaterialLibraryProps> = ({
               ä¸Šä¼ {title}
             </Button>
           </Upload>
+          </Space>
         </div>
         
         {/* ä¸Šä¼ è¿›åº¦æ¡ */}
diff --git a/src/components/new-ui/StepManager.tsx b/src/components/new-ui/StepManager.tsx
index a0fe9d4..297c9d6 100644
--- a/src/components/new-ui/StepManager.tsx
+++ b/src/components/new-ui/StepManager.tsx
@@ -108,6 +108,8 @@ const StepManager: React.FC<StepManagerProps> = ({
   
   const [currentTask, setCurrentTask] = useState<any>(null);
   const [pollingInterval, setPollingInterval] = useState<NodeJS.Timeout | null>(null);
+  // é˜²æ­¢é‡å¤å¼¹å‡ºâ€œè§†é¢‘ç”Ÿæˆå®Œæˆï¼â€çš„æç¤º
+  const [hasShownCompleteToast, setHasShownCompleteToast] = useState<boolean>(false);
   const [previewVisible, setPreviewVisible] = useState(false);
   const [previewVideo, setPreviewVideo] = useState<string>('');
   const [totalGenerationTime, setTotalGenerationTime] = useState<number>(0);
@@ -233,7 +235,12 @@ const StepManager: React.FC<StepManagerProps> = ({
       // 3. è¿›å…¥ç¬¬ä¸‰æ­¥
       setCurrentStep(2);
       
-      // 4. å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
+      // 4. å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€ï¼ˆå¯åŠ¨å‰æ¸…ç†æ—§çš„è½®è¯¢ï¼Œå¹¶é‡ç½®å®Œæˆæç¤ºçŠ¶æ€ï¼‰
+      if (pollingInterval) {
+        clearInterval(pollingInterval);
+        setPollingInterval(null);
+      }
+      setHasShownCompleteToast(false);
       startPolling(task.id);
       
       message.success('è§†é¢‘ç”Ÿæˆä»»åŠ¡å·²å¯åŠ¨ï¼Œè¯·ç¨å€™...');
@@ -298,8 +305,9 @@ const StepManager: React.FC<StepManagerProps> = ({
             const totalVideos = scripts.filter(s => s.selected).length;
             if (newVideos.length >= totalVideos) {
               // åªåœ¨ç¬¬ä¸€æ¬¡å®Œæˆæ—¶æ˜¾ç¤ºtoastï¼Œé¿å…é‡å¤æç¤º
-              if (generatedVideos.length < totalVideos) {
-                message.success('è§†é¢‘ç”Ÿæˆå®Œæˆï¼');
+              if (!hasShownCompleteToast) {
+                message.success({ key: 'gen_done', content: 'è§†é¢‘ç”Ÿæˆå®Œæˆï¼', duration: 3 });
+                setHasShownCompleteToast(true);
               }
               
               // æ·»åŠ åˆ°å†å²è®°å½•
@@ -322,6 +330,10 @@ const StepManager: React.FC<StepManagerProps> = ({
           setGenerationProgress(100);
           clearInterval(interval);
           setPollingInterval(null);
+          if (!hasShownCompleteToast) {
+            message.success({ key: 'gen_done', content: 'è§†é¢‘ç”Ÿæˆå®Œæˆï¼', duration: 3 });
+            setHasShownCompleteToast(true);
+          }
         }
         
         // å¦‚æœä»»åŠ¡å¤±è´¥
@@ -466,28 +478,58 @@ const StepManager: React.FC<StepManagerProps> = ({
                 ğŸ“¹ è§†é¢‘ç”Ÿæˆè¿›åº¦
               </h3>
               
-              {/* æ€»è€—æ—¶ç»Ÿè®¡ */}
+              {/* é¡¶éƒ¨ä¿¡æ¯æ¡ï¼ˆåˆå¹¶å®Œæˆæç¤ºä¸æ€»è€—æ—¶ï¼‰ */}
               {generationStartTime && (
                 <div style={{
                   marginBottom: '20px',
-                  padding: '12px 16px',
+                  padding: '6px 16px',
                   backgroundColor: '#f0f5ff',
                   border: '1px solid #d6e4ff',
                   borderRadius: '8px',
-                  textAlign: 'center'
+                  position: 'relative',
+                  height: '36px',
+                  overflow: 'hidden'
                 }}>
-                  <div style={{ 
-                    fontSize: '16px', 
-                    fontWeight: '500',
-                    color: '#1d39c4'
-                  }}>
-                    ğŸ•’ æ€»è€—æ—¶: {formatTime(totalGenerationTime)}
-                  </div>
+                  {generationProgress === 100 && generatedVideos.length > 0 ? (
+                    <>
+                      <div style={{
+                        position: 'absolute',
+                        left: '50%',
+                        top: '50%',
+                        transform: 'translate(-50%, -50%)',
+                        color: '#1677ff',
+                        fontWeight: 600
+                      }}>
+                        ğŸ† æ‰€æœ‰è§†é¢‘å·²ç”Ÿæˆï¼Œæ‚¨å¯ä»¥å¼€å§‹é¢„è§ˆå’Œä¸‹è½½
+                      </div>
+                      <div style={{
+                        position: 'absolute',
+                        right: '12px',
+                        top: '50%',
+                        transform: 'translateY(-50%)',
+                        color: '#595959'
+                      }}>
+                        æ€»è€—æ—¶: {formatTime(totalGenerationTime)}
+                      </div>
+                    </>
+                  ) : (
+                    <div style={{
+                      position: 'absolute',
+                      right: '12px',
+                      top: '50%',
+                      transform: 'translateY(-50%)',
+                      color: '#1d39c4',
+                      fontWeight: 500
+                    }}>
+                      ğŸ•’ æ€»è€—æ—¶: {formatTime(totalGenerationTime)}
+                    </div>
+                  )}
                 </div>
               )}
 
               {/* è¿›åº¦æ¡ */}
               <div style={{ marginBottom: '30px' }}>
+                {/* å®Œæˆæç¤ºå·²å¹¶å…¥é¡¶éƒ¨ä¿¡æ¯æ¡ï¼Œè¿™é‡Œä¸å†é‡å¤æ˜¾ç¤º */}
                 <div style={{ 
                   display: 'flex', 
                   justifyContent: 'space-between', 
@@ -535,22 +577,7 @@ const StepManager: React.FC<StepManagerProps> = ({
                     position: 'relative',
                     overflow: 'hidden'
                   }}>
-                    {/* å®ŒæˆçŠ¶æ€æŒ‡ç¤ºå™¨ */}
-                    <div style={{
-                      position: 'absolute',
-                      top: '16px',
-                      right: '16px',
-                      width: '32px',
-                      height: '32px',
-                      borderRadius: '50%',
-                      backgroundColor: '#52c41a',
-                      display: 'flex',
-                      alignItems: 'center',
-                      justifyContent: 'center',
-                      boxShadow: '0 2px 8px rgba(82, 196, 26, 0.3)'
-                    }}>
-                      <span style={{ color: 'white', fontSize: '16px', fontWeight: 'bold' }}>âœ“</span>
-                    </div>
+                    {/* ç§»é™¤å³ä¸Šè§’åœ†å½¢å…ƒç´ ï¼ˆåŸå‹¾é€‰/åˆ†äº«ç­‰åœ†å½¢å›¾æ ‡ï¼‰ */}
 
                     {/* è§†é¢‘ä¿¡æ¯ */}
                     <div style={{ marginBottom: '16px' }}>
@@ -561,7 +588,7 @@ const StepManager: React.FC<StepManagerProps> = ({
                         color: '#262626',
                         lineHeight: '1.4'
                       }}>
-                        {video.name}
+                        {(projectName ? `${projectName}_${String(index + 1).padStart(2, '0')}` : video.name)}
                       </h4>
                       <div style={{ fontSize: '12px', color: '#8c8c8c', lineHeight: '1.5' }}>
                         <div>ç”Ÿæˆæ—¶é—´: {video.createdAt ? new Date(video.createdAt).toLocaleString() : 'åˆšåˆš'}</div>
@@ -685,7 +712,7 @@ const StepManager: React.FC<StepManagerProps> = ({
                           e.currentTarget.style.boxShadow = '0 2px 4px rgba(24, 144, 255, 0.2)';
                         }}
                       >
-                        ğŸ¥ é¢„è§ˆè§†é¢‘
+                        é¢„è§ˆè§†é¢‘
                       </button>
                       <button 
                         onClick={(e) => {
@@ -693,7 +720,8 @@ const StepManager: React.FC<StepManagerProps> = ({
                           if (video.url) {
                             const link = document.createElement('a');
                             const downloadUrl = video.url.includes("oss-proxy") ? video.url.replace(":8000", ":9999") + "&download=true" : video.url; link.href = downloadUrl;
-                            link.download = `${video.name}.mp4`;
+                            const displayName = projectName ? `${projectName}_${String(index + 1).padStart(2, '0')}` : (video.name || `video_${index + 1}`);
+                            link.download = `${displayName}.mp4`;
                             document.body.appendChild(link);
                             link.click();
                             document.body.removeChild(link);
@@ -723,30 +751,24 @@ const StepManager: React.FC<StepManagerProps> = ({
                           e.currentTarget.style.boxShadow = '0 2px 4px rgba(82, 196, 26, 0.2)';
                         }}
                       >
-                        ğŸ“¥ ä¸‹è½½è§†é¢‘
+                        ä¸‹è½½è§†é¢‘
                       </button>
                     </div>
                   </div>
                 ))}
               </div>
 
-              {/* å®ŒæˆçŠ¶æ€ */}
+              {/* å®ŒæˆçŠ¶æ€ï¼ˆå»æ‰å¤–æ¡†ï¼Œä»…ä¿ç•™ç®€æ´æç¤ºæˆ–å®Œå…¨éšè—å¤–æ¡†ï¼‰ */}
               {generationProgress === 100 && generatedVideos.length > 0 && (
                 <div style={{
                   textAlign: 'center',
-                  padding: '20px',
-                  backgroundColor: '#f6ffed',
-                  border: '1px solid #b7eb8f',
-                  borderRadius: '8px',
-                  marginBottom: '20px'
+                  padding: 0,
+                  backgroundColor: 'transparent',
+                  border: 'none',
+                  borderRadius: 0,
+                  marginBottom: 0
                 }}>
-                  <div style={{ fontSize: '24px', marginBottom: '8px' }}>ğŸ‰</div>
-                  <h3 style={{ margin: 0, color: '#52c41a', fontSize: '16px' }}>
-                    æ‰€æœ‰è§†é¢‘ç”Ÿæˆå®Œæˆï¼
-                  </h3>
-                  <p style={{ margin: '4px 0 0 0', color: '#666', fontSize: '14px' }}>
-                    å…±ç”Ÿæˆ {generatedVideos.length} ä¸ªè§†é¢‘ï¼Œæ‚¨å¯ä»¥é¢„è§ˆå’Œä¸‹è½½
-                  </p>
+                  <div style={{ fontSize: '0px', height: 0, overflow: 'hidden' }}></div>
                 </div>
               )}
             </div>
-- 
2.43.7

